<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイムアタッククイズ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Clock, Trophy, RotateCcw, Crown, User, Medal } = lucide;

        const QuizGame = () => {
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(10);
            const [gameState, setGameState] = useState('ready');
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [startTime, setStartTime] = useState(null);
            const [previewTime, setPreviewTime] = useState(2.5);
            const [pointsEarned, setPointsEarned] = useState(0);
            const [playerName, setPlayerName] = useState('');
            const [rankings, setRankings] = useState([]);
            const [loading, setLoading] = useState(false);

            // GitHub Pages用の設定
            const GITHUB_USERNAME = 'hirudoido'; // ここを自分のGitHubユーザー名に変更
            const REPO_NAME = 'quiz-rankingDEMO-app'; // ここを自分のリポジトリ名に変更
            const GITHUB_TOKEN = ''; // 後で設定

            const questions = [
                {
                    image: "🍎", 
                    question: "この果物は何ですか？",
                    options: ["りんご", "みかん"],
                    correct: 0
                },
                {
                    image: "🐱",
                    question: "この動物は何ですか？",
                    options: ["いぬ", "ねこ"],
                    correct: 1
                },
                {
                    image: "🚗",
                    question: "これは何ですか？",
                    options: ["くるま", "でんしゃ"],
                    correct: 0
                },
                {
                    image: "🌞",
                    question: "これは何ですか？",
                    options: ["つき", "たいよう"],
                    correct: 1
                },
                {
                    image: "📚",
                    question: "これは何ですか？",
                    options: ["ほん", "ぺん"],
                    correct: 0
                }
            ];

            // ランキング読み込み
            useEffect(() => {
                loadRankings();
            }, []);

            const loadRankings = async () => {
                try {
                    const response = await fetch(`https://${GITHUB_USERNAME}.github.io/${REPO_NAME}/rankings.json`);
                    if (response.ok) {
                        const data = await response.json();
                        setRankings(data);
                    } else {
                        // ファイルが見つからない場合は初期データを使用
                        setRankings([
                            { name: "クイズマスター", score: 485, date: "2025-06-20" },
                            { name: "スピードキング", score: 467, date: "2025-06-21" },
                            { name: "ひらめき太郎", score: 445, date: "2025-06-19" },
                            { name: "思考の達人", score: 423, date: "2025-06-22" },
                            { name: "知識の女王", score: 398, date: "2025-06-18" }
                        ]);
                    }
                } catch (error) {
                    console.error('ランキング読み込みエラー:', error);
                    // エラー時は初期データを使用
                    setRankings([
                        { name: "クイズマスター", score: 485, date: "2025-06-20" },
                        { name: "スピードキング", score: 467, date: "2025-06-21" },
                        { name: "ひらめき太郎", score: 445, date: "2025-06-19" },
                        { name: "思考の達人", score: 423, date: "2025-06-22" },
                        { name: "知識の女王", score: 398, date: "2025-06-18" }
                    ]);
                }
            };

            // ランキング更新（GitHub API使用）
            const updateRankings = async (newRankings) => {
                if (!GITHUB_TOKEN || GITHUB_TOKEN === 'YOUR_GITHUB_TOKEN') {
                    alert('GitHub Tokenが設定されていません。ランキングはローカルでのみ保存されます。');
                    setRankings(newRankings);
                    return;
                }

                setLoading(true);
                try {
                    // 現在のファイル情報を取得
                    const fileResponse = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/rankings.json`, {
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    let sha = null;
                    if (fileResponse.ok) {
                        const fileData = await fileResponse.json();
                        sha = fileData.sha;
                    }

                    // ファイルを更新
                    const content = btoa(JSON.stringify(newRankings, null, 2));
                    const updateResponse = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/rankings.json`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_TOKEN}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Update rankings',
                            content: content,
                            sha: sha
                        })
                    });

                    if (updateResponse.ok) {
                        setRankings(newRankings);
                        alert('ランキングが更新されました！');
                    } else {
                        throw new Error('ランキング更新に失敗しました');
                    }
                } catch (error) {
                    console.error('ランキング更新エラー:', error);
                    alert('ランキング更新に失敗しました。ローカルでのみ保存されます。');
                    setRankings(newRankings);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                let timer;
                if (gameState === 'preview' && previewTime > 0) {
                    timer = setTimeout(() => {
                        setPreviewTime(previewTime - 0.1);
                    }, 100);
                } else if (previewTime <= 0 && gameState === 'preview') {
                    setGameState('playing');
                    setStartTime(Date.now());
                }
                return () => clearTimeout(timer);
            }, [previewTime, gameState]);

            useEffect(() => {
                let timer;
                if (gameState === 'playing' && timeLeft > 0) {
                    timer = setTimeout(() => {
                        setTimeLeft(timeLeft - 1);
                    }, 1000);
                } else if (timeLeft === 0 && gameState === 'playing') {
                    handleAnswer(null, true);
                }
                return () => clearTimeout(timer);
            }, [timeLeft, gameState]);

            const startGame = () => {
                setCurrentQuestion(0);
                setScore(0);
                setSelectedAnswer(null);
                setIsCorrect(null);
                setPointsEarned(0);
                setPlayerName('');
                setGameState('preview');
                setPreviewTime(2.5);
                setTimeLeft(10);
            };

            const calculatePoints = (isCorrect, responseTime, isTimeout = false) => {
                if (isTimeout) {
                    return -50;
                }
                
                if (isCorrect) {
                    return Math.max(10, Math.round(100 - (responseTime * 9)));
                } else {
                    return Math.min(-10, Math.round(-50 + (responseTime * 4)));
                }
            };

            const handleAnswer = (answerIndex, isTimeout = false) => {
                if (gameState !== 'playing') return;

                const question = questions[currentQuestion];
                const correct = !isTimeout && answerIndex === question.correct;
                const responseTime = isTimeout ? 10 : (Date.now() - startTime) / 1000;
                
                setSelectedAnswer(answerIndex);
                setIsCorrect(correct);
                setGameState('answered');

                const points = calculatePoints(correct, responseTime, isTimeout);
                setPointsEarned(points);
                setScore(score + points);

                setTimeout(() => {
                    if (currentQuestion < questions.length - 1) {
                        setCurrentQuestion(currentQuestion + 1);
                        setTimeLeft(10);
                        setPreviewTime(2.5);
                        setSelectedAnswer(null);
                        setIsCorrect(null);
                        setPointsEarned(0);
                        setGameState('preview');
                        setStartTime(null);
                    } else {
                        if (isRankingWorthy(score + points)) {
                            setGameState('nameInput');
                        } else {
                            setGameState('finished');
                        }
                    }
                }, 2500);
            };

            const isRankingWorthy = (finalScore) => {
                return finalScore >= 100 || rankings.length < 10 || finalScore > Math.min(...rankings.map(r => r.score));
            };

            const addToRanking = () => {
                if (!playerName.trim()) return;
                
                const newEntry = {
                    name: playerName.trim(),
                    score: score,
                    date: new Date().toISOString().split('T')[0]
                };

                const newRankings = [...rankings, newEntry]
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);

                updateRankings(newRankings);
                setGameState('finished');
            };

            const resetGame = () => {
                setCurrentQuestion(0);
                setScore(0);
                setTimeLeft(10);
                setPreviewTime(2.5);
                setGameState('ready');
                setSelectedAnswer(null);
                setIsCorrect(null);
                setStartTime(null);
                setPointsEarned(0);
                setPlayerName('');
            };

            const showRanking = () => {
                setGameState('ranking');
            };

            const backToMenu = () => {
                setGameState('ready');
            };

            const getScoreColor = () => {
                if (score >= 300) return 'text-green-600';
                if (score >= 150) return 'text-blue-600';
                if (score >= 0) return 'text-gray-700';
                return 'text-red-600';
            };

            const getRankIcon = (rank) => {
                if (rank === 1) return React.createElement(Crown, { className: "text-yellow-500", size: 20 });
                if (rank === 2) return React.createElement(Medal, { className: "text-gray-400", size: 20 });
                if (rank === 3) return React.createElement(Medal, { className: "text-orange-600", size: 20 });
                return React.createElement('span', { className: "text-gray-600 font-bold" }, rank);
            };

            const renderImage = (question) => {
                return React.createElement('div', { className: "text-8xl" }, question.image);
            };

            // ランキング画面
            if (gameState === 'ranking') {
                return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full" },
                        React.createElement('div', { className: "text-center mb-6" },
                            React.createElement(Trophy, { className: "mx-auto text-yellow-500 mb-4", size: 64 }),
                            React.createElement('h1', { className: "text-3xl font-bold text-gray-800" }, "🌍 世界ランキング")
                        ),
                        React.createElement('div', { className: "space-y-3 mb-6 max-h-96 overflow-y-auto" },
                            rankings.map((entry, index) =>
                                React.createElement('div', { 
                                    key: index, 
                                    className: `flex items-center justify-between p-3 rounded-lg ${
                                        index < 3 ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200' : 'bg-gray-50'
                                    }`
                                },
                                    React.createElement('div', { className: "flex items-center gap-3" },
                                        getRankIcon(index + 1),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: "font-bold text-gray-800" }, entry.name),
                                            React.createElement('div', { className: "text-xs text-gray-500" }, entry.date)
                                        )
                                    ),
                                    React.createElement('div', { className: "text-lg font-bold text-blue-600" }, entry.score + "点")
                                )
                            )
                        ),
                        React.createElement('button', {
                            onClick: backToMenu,
                            className: "w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-6 rounded-full hover:from-gray-600 hover:to-gray-700 transition-all duration-200"
                        }, "メニューに戻る")
                    )
                );
            }

            // 名前入力画面
            if (gameState === 'nameInput') {
                return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md w-full" },
                        React.createElement(Trophy, { className: "mx-auto text-yellow-500 mb-4", size: 64 }),
                        React.createElement('h1', { className: "text-2xl font-bold text-gray-800 mb-2" }, "🎉 ランキング入り！"),
                        React.createElement('p', { className: "text-lg text-blue-600 font-bold mb-6" }, "スコア: " + score + "点"),
                        React.createElement('div', { className: "mb-6" },
                            React.createElement('label', { className: "block text-gray-700 font-bold mb-2" }, "あなたの名前を入力してください"),
                            React.createElement('div', { className: "relative" },
                                React.createElement(User, { className: "absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400", size: 20 }),
                                React.createElement('input', {
                                    type: "text",
                                    value: playerName,
                                    onChange: (e) => setPlayerName(e.target.value),
                                    placeholder: "ニックネーム（10文字以内）",
                                    maxLength: 10,
                                    className: "w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-full focus:border-blue-500 focus:outline-none text-center font-bold",
                                    onKeyPress: (e) => e.key === 'Enter' && addToRanking()
                                })
                            )
                        ),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('button', {
                                onClick: addToRanking,
                                disabled: !playerName.trim() || loading,
                                className: `w-full font-bold py-3 px-6 rounded-full transition-all duration-200 ${
                                    playerName.trim() && !loading
                                        ? 'bg-gradient-to-r from-green-500 to-blue-600 text-white hover:from-green-600 hover:to-blue-700 transform hover:scale-105'
                                        : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                }`
                            }, loading ? "更新中..." : "ランキングに登録"),
                            React.createElement('button', {
                                onClick: () => setGameState('finished'),
                                className: "w-full bg-gray-200 text-gray-600 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition-all duration-200"
                            }, "スキップ")
                        )
                    )
                );
            }

            // メイン画面
            if (gameState === 'ready') {
                return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md w-full" },
                        React.createElement(Trophy, { className: "mx-auto text-yellow-500 mb-4", size: 64 }),
                        React.createElement('h1', { className: "text-3xl font-bold text-gray-800 mb-4" }, "タイムアタッククイズ"),
                        React.createElement('div', { className: "text-left text-sm text-gray-600 mb-6 bg-gray-50 p-4 rounded-lg" },
                            React.createElement('h3', { className: "font-bold mb-2" }, "ルール："),
                            React.createElement('ul', { className: "space-y-1" },
                                React.createElement('li', null, "• 最初2.5秒は画像を観察"),
                                React.createElement('li', null, "• その後10秒で回答"),
                                React.createElement('li', null, "• ", React.createElement('span', { className: "text-green-600" }, "正解"), "：早いほど高得点（10-100点）"),
                                React.createElement('li', null, "• ", React.createElement('span', { className: "text-red-600" }, "間違い"), "：早いほど大きなマイナス（-50〜-10点）"),
                                React.createElement('li', null, "• ", React.createElement('span', { className: "text-red-600" }, "時間切れ"), "：-50点")
                            )
                        ),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('button', {
                                onClick: startGame,
                                className: "w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-8 rounded-full hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200"
                            }, "ゲーム開始！"),
                            React.createElement('button', {
                                onClick: showRanking,
                                className: "w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-bold py-3 px-8 rounded-full hover:from-yellow-600 hover:to-orange-700 transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-2"
                            }, 
                                React.createElement(Crown, { size: 20 }),
                                "世界ランキングを見る"
                            )
                        )
                    )
                );
            }

            if (gameState === 'finished') {
                return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 flex items-center justify-center p-4" },
                    React.createElement('div', { className: "bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md w-full" },
                        React.createElement(Trophy, { className: "mx-auto text-yellow-500 mb-4", size: 64 }),
                        React.createElement('h1', { className: "text-3xl font-bold text-gray-800 mb-4" }, "ゲーム終了！"),
                        React.createElement('p', { className: "text-2xl font-bold mb-6" },
                            "最終スコア: ", React.createElement('span', { className: getScoreColor() }, score + "点")
                        ),
                        React.createElement('div', { className: "mb-6 text-gray-600" },
                            score >= 400 ? "🏆 パーフェクト！神業です！" :
                            score >= 300 ? "🌟 素晴らしい！" :
                            score >= 200 ? "👍 とても良い成績！" :
                            score >= 100 ? "📚 まずまずの成績！" :
                            score >= 0 ? "💪 もう少し慎重に！" :
                            "🤔 落ち着いて考えよう！"
                        ),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('button', {
                                onClick: resetGame,
                                className: "w-full bg-gradient-to-r from-green-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 flex items-center gap-2 justify-center"
                            },
                                React.createElement(RotateCcw, { size: 20 }),
                                "もう一度プレイ"
                            ),
                            React.createElement('button', {
                                onClick: showRanking,
                                className: "w-full bg-gradient-to-r from-yellow-500 to-orange-600 text-white font-bold py-3 px-8 rounded-full hover:from-yellow-600 hover:to-orange-700 transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-2"
                            },
                                React.createElement(Crown, { size: 20 }),
                                "ランキングを見る"
                            )
                        )
                    )
                );
            }

            const question = questions[currentQuestion];

            return React.createElement('div', { className: "min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 flex items-center justify-center p-4" },
                React.createElement('div', { className: "bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" },
                        React.createElement('div', { className: "text-sm text-gray-600" },
                            "問題 " + (currentQuestion + 1) + "/" + questions.length
                        ),
                        React.createElement('div', { className: `text-2xl font-bold ${getScoreColor()}` },
                            score + "点"
                        )
                    ),
                    gameState === 'preview' && React.createElement('div', { className: "text-center mb-6" },
                        React.createElement('div', { className: "inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-100 text-blue-600" },
                            React.createElement(Clock, { size: 20 }),
                            React.createElement('span', { className: "text-lg font-bold" }, "観察時間 " + Math.ceil(previewTime) + "秒")
                        )
                    ),
                    gameState === 'playing' && React.createElement('div', { className: "text-center mb-6" },
                        React.createElement('div', { 
                            className: `inline-flex items-center gap-2 px-4 py-2 rounded-full ${
                                timeLeft <= 3 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-green-100 text-green-600'
                            }`
                        },
                            React.createElement(Clock, { size: 20 }),
                            React.createElement('span', { className: "text-xl font-bold" }, timeLeft + "秒")
                        )
                    ),
                    React.createElement('div', { className: "text-center mb-8" },
                        React.createElement('div', { className: "mb-4" },
                            renderImage(question)
                        ),
                        React.createElement('h2', { className: "text-xl font-bold text-gray-800" }, question.question)
                    ),
                    gameState !== 'preview' && React.createElement('div', { className: "space-y-3" },
                        question.options.map((option, index) =>
                            React.createElement('button', {
                                key: index,
                                onClick: () => handleAnswer(index),
                                disabled: gameState === 'answered',
                                className: `w-full p-4 rounded-xl font-bold text-lg transition-all duration-200 ${
                                    gameState === 'answered'
                                        ? selectedAnswer === index
                                            ? isCorrect
                                                ? 'bg-green-500 text-white'
                                                : 'bg-red-500 text-white'
                                            : index === question.correct
                                                ? 'bg-green-500 text-white'
                                                : 'bg-gray-300 text-gray-600'
                                        : 'bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 transform hover:scale-105'
                                }`
                            }, option)
                        )
                    ),
                    gameState === 'answered' && React.createElement('div', { className: "mt-4 text-center" },
                        React.createElement('p', { className: `text-lg font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}` },
                            isCorrect ? '正解！🎉' : selectedAnswer === null ? '時間切れ⏰' : '不正解... 😢'
                        ),
                        React.createElement('p', { className: `text-sm font-bold ${pointsEarned > 0 ? 'text-green-600' : 'text-red-600'}` },
                            (pointsEarned > 0 ? '+' : '') + pointsEarned + "点"
                        ),
                        !isCorrect && selectedAnswer !== null && React.createElement('p', { className: "text-xs text-gray-500 mt-1" },
                            "早押しは危険！よく考えてから答えよう"
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(QuizGame), document.getElementById('root'));
    </script>
</body>
</html>
